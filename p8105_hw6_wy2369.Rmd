---
title: "p8105_hw6_wy2369"
output: github_document
author: Wenjing Yang
date: "2022-11-29"
---

```{r, include=FALSE}
library(tidyverse)
library(viridis)
library(patchwork)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1


# Problem 2

### Read and clean

Create a `city_state` variable and a `homicide_status` (binary) variable indicating whether the homicide is solved. Number 0 means "unsolved" and 1 means "solved"

Then omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. Filter whom victim_race is white or black, and convert `victim_age` to numerical variable. Drop NAs which shown in `victim_age`. 

```{r,message=FALSE}
homicide_data = 
  read_csv("./data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    city_state = str_c(city, ",", state),
    victim_age = as.numeric(victim_age),
    homicide_status =  ifelse(disposition != "Closed by arrest", 0, 1)) %>% 
  filter(city_state != "Dallas,TX" & city_state != "Phoenix,AZ" & city_state !="Kansas City,MO" & city_state != "Tulsa,AL") %>% 
  filter(victim_race == "White" | victim_race == "Black") %>% 
  drop_na(victim_age)
```

### Fit a logistic regression for one city

Use the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and `victim_age`, `victim_sex` and `victim_race` as predictors. Save the output of `glm` as an R object and apply the `broom::tidy` to tidy the data. 

```{r}
baltimore_reg = 
  homicide_data %>% 
  filter(city_state == "Baltimore,MD") %>% 
  glm(homicide_status ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    odds_ratio = exp(estimate),
    lower_CI = exp(estimate - 1.96 * std.error),
    upper_CI = exp(estimate + 1.96 * std.error)
  ) %>% 
  filter(term == "victim_sexMale") %>% 
  select(term, estimate, odds_ratio, lower_CI, upper_CI) %>% 
  knitr::kable(digits = 3)

baltimore_reg
```

From the table, I obtain the estimate is **-0.854**，adjusted odds_ratio is **0.426** and confidence interval is **(0.325, 0.558)** for solving homicides comparing male victims to female victims keeping all other variables fixed.

### Fit a logistic regression for each cities

Run `glm` for each of the cities in the dataset and use `map` and `unnest` functions to create a tidy dataframe with estimates, odds ratios and confidence intervals for each city.

```{r}
homicide_reg = 
  homicide_data %>% 
  nest(data = -city_state) %>% 
  mutate(
    results = map(.x = data ,~glm(homicide_status ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    results = map(results, broom::tidy)) %>% 
  unnest(results) %>%
  mutate(
    odds_ratio = exp(estimate),
    lower_CI = exp(estimate - 1.96 * std.error),
    upper_CI = exp(estimate + 1.96 * std.error)
  ) %>% 
  filter(term == "victim_sexMale") %>% 
  select(city_state, estimate, odds_ratio, lower_CI, upper_CI) %>% 
  knitr::kable(digits = 3)

homicide_reg 
```

### Create a plot 

The plot shows the estimated odds ratios and confidence intervals for each city. 

```{r}

  
```

Organize cities according to estimated OR, and comment on the plot.

